# Conversation Memory Log — WorldSize Torus Mod (Updated)

**Date:** February 24, 2026 (continued from February 21, 2026)
**Project:** Minecraft Fabric mod (1.21.11, Mojang mappings) that wraps world terrain on X/Z axes to create a torus topology.
**Repo:** `Torus-World`
**License:** GPLv3
**Package:** `base.worldsize`

---

## Session 3 — February 24, 2026

### Problem Reported
After applying the Session 2 fixes (volatile flag, constructor-arg wrapping), the mod crashes at world creation:

```
net.minecraft.ReportedException: Exception chunk generation/loading
    at MinecraftServer.createLevels(MinecraftServer.java:447)
Caused by: java.lang.ArrayIndexOutOfBoundsException: Index -130 out of bounds for length 315
```

The 315-element array is the Aquifer's internal grid (likely 5×7×9 or similar). The -130 index means coordinates are severely misaligned with the grid.

### Root Cause: Ambiguous `@ModifyArg` Target

The `NoiseChunkMixin` from Session 2 used:
```java
@ModifyArg(method = "forChunk", at = @At(value = "INVOKE", target = "<init>"), index = 2)
```

**The bug:** `target = "<init>"` without a class qualifier matches ALL constructor invocations in `forChunk()`, not just `new NoiseChunk(...)`. The method `forChunk()` also creates helper objects like `Aquifer.FluidStatus(int level, BlockState state)` before the NoiseChunk. The `@ModifyArg(index=2)` was applied to the wrong constructor, corrupting a FluidStatus parameter or other object, which cascaded into the Aquifer computing invalid grid indices.

### Fix Applied

**Strategy change:** Replaced `@ModifyArg` on `<init>` with `@Redirect` on `ChunkAccess.getPos()`.

Instead of trying to modify specific constructor parameters (fragile, ambiguous), we now intercept the `chunk.getPos()` call in `forChunk()` and return a wrapped `ChunkPos`. This is:
1. **Unambiguous** — `ChunkAccess.getPos()` is a unique, well-defined method call
2. **More thorough** — ALL position-derived values in `forChunk()` see wrapped coordinates (not just startBlockX/Z, but also FluidPicker setup, any offset calculations, etc.)
3. **Simpler** — One redirect replaces two `@ModifyArg` annotations

```java
@Redirect(
    method = "forChunk",
    at = @At(value = "INVOKE",
        target = "Lnet/minecraft/world/level/chunk/ChunkAccess;getPos()Lnet/minecraft/world/level/chunk/ChunkPos;")
)
private static ChunkPos wrapChunkPosInForChunk(ChunkAccess chunk) {
    if (TorusChunkGenerator.isTorusActive()) {
        ChunkPos real = chunk.getPos();
        int wrappedChunkX = WorldSize.wrapChunk(real.x);
        int wrappedChunkZ = WorldSize.wrapChunk(real.z);
        if (wrappedChunkX != real.x || wrappedChunkZ != real.z) {
            return new ChunkPos(wrappedChunkX, wrappedChunkZ);
        }
        return real;
    }
    return chunk.getPos();
}
```

### Additional Fix: en_us.json Location

The language file was at the wrong path:
- **Wrong:** `src/main/resources/data/minecraft/tags/worldgen/world_preset/En us.json`
- **Correct:** `src/main/resources/assets/worldsize/lang/en_us.json`

The old file at the wrong path should be deleted.

### Files Changed
| File | Change |
|------|--------|
| `NoiseChunkMixin.java` | Rewritten: `@ModifyArg` on `<init>` → `@Redirect` on `getPos()` |
| `assets/worldsize/lang/en_us.json` | Created at correct path |
| `data/minecraft/tags/worldgen/world_preset/En us.json` | Should be DELETED (wrong path) |

### Potential Startup Errors

If the @Redirect doesn't match at startup, possible causes:
1. `forChunk` doesn't call `chunk.getPos()` directly — check decompiled source for the actual method call
2. The method is on a different type (e.g., `LevelHeightAccessor.getPos()`) — update the target descriptor
3. `forChunk` has been renamed in 1.21.11 — check the actual method name in decompiled NoiseChunk

**Fallback approach** if @Redirect fails: Use `@ModifyArg` with a fully-qualified constructor target:
```java
target = "Lnet/minecraft/world/level/levelgen/NoiseChunk;<init>(ILnet/minecraft/world/level/levelgen/RandomState;II...)V"
```
(Fill in the exact descriptor from the decompiled constructor)

---

## Previous Sessions Summary

### Session 1 (before this conversation)
- Created initial TorusChunkGenerator with delegation to NoiseBasedChunkGenerator
- Tried wrapping in getBaseHeight/getBaseColumn, WrappedChunkAccess, fillFromNoise copy — all compiled but didn't wrap

### Session 2 (February 21, 2026)
- Diagnosed ThreadLocal invisible to async worker threads
- Fixed with `static volatile boolean TORUS_ACTIVE`
- Added 7 mixins for coordinate wrapping at all pipeline stages
- Fixed SurfaceRulesContextMixin injection point (HEAD→TAIL) and coordinate scale
- Fixed biome source recursion guards (separated from torus flag)
- **Introduced the `@ModifyArg` bug** that Session 3 fixes

---

## Architecture (Current)

```
base.worldsize/
├── WorldSize.java              — ModInitializer, constants, wrapping utilities, player teleport
├── TorusChunkGenerator.java    — Extends ChunkGenerator, delegates to NoiseBasedChunkGenerator
└── mixin/
    ├── NoiseChunkMixin.java                    — Core: @Redirect on getPos() in forChunk()
    ├── MultiNoiseBiomeSourceMixin.java         — Wraps biome lookups (overworld)
    ├── FixedBiomeSourceMixin.java              — Wraps biome lookups (fixed biome)
    ├── CheckerboardColumnBiomeSourceMixin.java — Wraps biome lookups (checkerboard)
    ├── TheEndBiomeSourceMixin.java             — Wraps biome lookups (end)
    ├── SurfaceRulesContextMixin.java           — Wraps surface rule coordinates
    └── FeaturePlaceContextMixin.java           — Wraps feature placement origins

Resources:
├── fabric.mod.json
├── worldsize.mixins.json
├── data/worldsize/worldgen/world_preset/torus.json
├── data/minecraft/tags/worldgen/world_preset/normal.json
└── assets/worldsize/lang/en_us.json              ← FIXED LOCATION
```

## Session 3 Continued — Package Relocations in 1.21.11

### Problem: `Cannot resolve symbol 'ChunkPos'`

After applying the `@Redirect` fix, the code failed to compile because `ChunkPos` could not be found at the import path `net.minecraft.world.level.chunk.ChunkPos`.

### Root Cause: Class Relocation in 1.21.11 Mojang Mappings

In 1.21.11, `ChunkPos` was moved to a different package:
- **Wrong (old path):** `net.minecraft.world.level.chunk.ChunkPos`
- **Correct (1.21.11):** `net.minecraft.world.level.ChunkPos`

This was confirmed by inspecting the mapped Minecraft jar:
```bash
jar tf ~/.gradle/caches/fabric-loom/minecraftMaven/net/minecraft/minecraft-merged/1.21.11-loom.mappings.1_21_11.layered+hash.2198-v2/minecraft-merged-*.jar | grep -i chunkpos
# Result: net/minecraft/world/level/ChunkPos.class
```

### Verified Class Locations (1.21.11 Mojang Mappings)

| Class | Package |
|-------|---------|
| `ChunkPos` | `net.minecraft.world.level.ChunkPos` |
| `ChunkAccess` | `net.minecraft.world.level.chunk.ChunkAccess` |
| `NoiseChunk` | `net.minecraft.world.level.levelgen.NoiseChunk` |

### Fix Applied

Updated both the import AND the `@Redirect` target descriptor in `NoiseChunkMixin.java`:

```java
// Import fix
import net.minecraft.world.level.ChunkPos;  // was: net.minecraft.world.level.chunk.ChunkPos

// Target descriptor fix
target = "Lnet/minecraft/world/level/chunk/ChunkAccess;getPos()Lnet/minecraft/world/level/ChunkPos;"
//  was: ...getPos()Lnet/minecraft/world/level/chunk/ChunkPos;"
```

### Key Lesson
**Always verify class locations from the actual mapped jar** rather than assuming paths from documentation or older versions. In Mojang mappings, classes can be relocated between versions. Use:
```bash
jar tf <mapped-minecraft-jar> | grep -i <classname>
```

### How to Find the Mapped Jar
```bash
find ~/.gradle -path "*loom*" -name "*minecraft-merged*" -name "*.jar" | grep mappings
```

---

## Session 3 Continued — Crash Persists After @Redirect Fix

### Problem
After fixing the `ChunkPos` package path, the crash persists:
```
ArrayIndexOutOfBoundsException: Index -139 out of bounds for length 315
    at Aquifer$NoiseBasedAquifer.computeSubstance(Aquifer.java:188)
    at NoiseChunk.method_40530(NoiseChunk.java:158)
    at MaterialRuleList.calculate(MaterialRuleList.java:13)
    at NoiseChunk.getInterpolatedState(NoiseChunk.java:180)
    at NoiseBasedChunkGenerator.doFill(NoiseBasedChunkGenerator.java:399)
    at NoiseBasedChunkGenerator.method_38332(NoiseBasedChunkGenerator.java:347)
```

The index changed (-130 → -139) but the crash pattern is identical. This confirms:
1. The `@Redirect` on `getPos()` IS matching (the index changed, meaning wrapping is happening)
2. But there's a **coordinate mismatch** between where NoiseChunk thinks it is vs where `doFill` iterates

### Bytecode Analysis of `forChunk()`

Confirmed via `javap -c` that `forChunk()` in 1.21.11:
```
11: invokevirtual  ChunkAccess.getPos:()Lnet/minecraft/world/level/ChunkPos;
14: astore 7
...
35: invokevirtual  ChunkPos.getMinBlockX:()I
...
40: invokevirtual  ChunkPos.getMinBlockZ:()I
```

So `forChunk()` calls `chunk.getPos()` → stores in local var 7 → calls `getMinBlockX()`/`getMinBlockZ()` on the result. Our `@Redirect` successfully wraps the `ChunkPos`, so `NoiseChunk` is constructed with wrapped startBlockX/startBlockZ.

### Root Cause Hypothesis: Coordinate Mismatch in `doFill()`

The Aquifer grid is set up during NoiseChunk construction using wrapped coordinates (e.g., position 0-1023). But `doFill()` in `NoiseBasedChunkGenerator` computes block positions from the **real chunk's position** (e.g., chunk at X=1024+), NOT from the NoiseChunk's internal wrapped coordinates.

The flow:
1. `forChunk()` creates NoiseChunk with wrapped pos → Aquifer grid covers wrapped range (e.g., 0..15)
2. `doFill()` iterates over the real chunk's block positions (e.g., 1024..1039)
3. `computeSubstance()` receives real coords (1024+) but Aquifer grid expects wrapped coords (0..15)
4. Grid index = (realCoord - wrappedGridStart) → (1024 - 0) / cellSize → massive negative or OOB index

### Next Steps: Decompile `doFill()` and `computeSubstance()`

Need to examine:
1. **`NoiseBasedChunkGenerator.doFill()`** — how it computes X/Z for each block
2. **`Aquifer$NoiseBasedAquifer.computeSubstance()`** — how it converts block coords to grid indices

Possible fixes:
- **Option A:** Also mixin `doFill()` to wrap coordinates passed to NoiseChunk methods
- **Option B:** Mixin `Aquifer$NoiseBasedAquifer.computeSubstance()` to wrap input coordinates
- **Option C:** Wrap at a higher level — intercept the chunk passed to `fillFromNoise()` so both NoiseChunk AND doFill see consistent wrapped positions

### Commands to Run Next
```bash
cd /tmp
javap -c -p net/minecraft/world/level/levelgen/NoiseBasedChunkGenerator.class | sed -n '/doFill/,/^  [a-z]/p' | head -100
javap -c -p net/minecraft/world/level/levelgen/Aquifer\$NoiseBasedAquifer.class | sed -n '/computeSubstance/,/^  [a-z]/p' | head -60
```

---

## Known Issues / Follow-Up
1. Structure generation may not wrap correctly
2. Entity wrapping only covers players (not mobs/projectiles)
3. All dimensions wrap (Overworld, Nether, End) — per-dimension control not implemented
4. World size hardcoded to 64 chunks (1024 blocks)
5. Client-side rendering at wrap boundaries not addressed
6. Seamless visual transition at boundaries not implemented

## Key Lesson from Session 3
**Always qualify Mixin targets fully.** A bare `<init>` or method name can match multiple bytecode instructions. Use the fully-qualified owner class (`Lpackage/Class;methodName`) to ensure the correct instruction is targeted. When possible, prefer `@Redirect` on specific method calls over `@ModifyArg` on constructor parameters — it's harder to accidentally target the wrong thing.