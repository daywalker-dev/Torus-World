# Conversation Memory Log — WorldSize Torus Mod (Updated)

**Date:** February 24, 2026 (continued from February 21, 2026)
**Project:** Minecraft Fabric mod (1.21.11, Mojang mappings) that wraps world terrain on X/Z axes to create a torus topology.
**Repo:** `Torus-World`
**License:** GPLv3
**Package:** `base.worldsize`

---

## Session 3 — February 24, 2026

### Problem Reported
After applying the Session 2 fixes (volatile flag, constructor-arg wrapping), the mod crashes at world creation:

```
net.minecraft.ReportedException: Exception chunk generation/loading
    at MinecraftServer.createLevels(MinecraftServer.java:447)
Caused by: java.lang.ArrayIndexOutOfBoundsException: Index -130 out of bounds for length 315
```

The 315-element array is the Aquifer's internal grid (likely 5×7×9 or similar). The -130 index means coordinates are severely misaligned with the grid.

### Root Cause: Ambiguous `@ModifyArg` Target

The `NoiseChunkMixin` from Session 2 used:
```java
@ModifyArg(method = "forChunk", at = @At(value = "INVOKE", target = "<init>"), index = 2)
```

**The bug:** `target = "<init>"` without a class qualifier matches ALL constructor invocations in `forChunk()`, not just `new NoiseChunk(...)`. The method `forChunk()` also creates helper objects like `Aquifer.FluidStatus(int level, BlockState state)` before the NoiseChunk. The `@ModifyArg(index=2)` was applied to the wrong constructor, corrupting a FluidStatus parameter or other object, which cascaded into the Aquifer computing invalid grid indices.

### Fix Applied

**Strategy change:** Replaced `@ModifyArg` on `<init>` with `@Redirect` on `ChunkAccess.getPos()`.

Instead of trying to modify specific constructor parameters (fragile, ambiguous), we now intercept the `chunk.getPos()` call in `forChunk()` and return a wrapped `ChunkPos`. This is:
1. **Unambiguous** — `ChunkAccess.getPos()` is a unique, well-defined method call
2. **More thorough** — ALL position-derived values in `forChunk()` see wrapped coordinates (not just startBlockX/Z, but also FluidPicker setup, any offset calculations, etc.)
3. **Simpler** — One redirect replaces two `@ModifyArg` annotations

```java
@Redirect(
    method = "forChunk",
    at = @At(value = "INVOKE",
        target = "Lnet/minecraft/world/level/chunk/ChunkAccess;getPos()Lnet/minecraft/world/level/chunk/ChunkPos;")
)
private static ChunkPos wrapChunkPosInForChunk(ChunkAccess chunk) {
    if (TorusChunkGenerator.isTorusActive()) {
        ChunkPos real = chunk.getPos();
        int wrappedChunkX = WorldSize.wrapChunk(real.x);
        int wrappedChunkZ = WorldSize.wrapChunk(real.z);
        if (wrappedChunkX != real.x || wrappedChunkZ != real.z) {
            return new ChunkPos(wrappedChunkX, wrappedChunkZ);
        }
        return real;
    }
    return chunk.getPos();
}
```

### Additional Fix: en_us.json Location

The language file was at the wrong path:
- **Wrong:** `src/main/resources/data/minecraft/tags/worldgen/world_preset/En us.json`
- **Correct:** `src/main/resources/assets/worldsize/lang/en_us.json`

The old file at the wrong path should be deleted.

### Files Changed
| File | Change |
|------|--------|
| `NoiseChunkMixin.java` | Rewritten: `@ModifyArg` on `<init>` → `@Redirect` on `getPos()` |
| `assets/worldsize/lang/en_us.json` | Created at correct path |
| `data/minecraft/tags/worldgen/world_preset/En us.json` | Should be DELETED (wrong path) |

### Potential Startup Errors

If the @Redirect doesn't match at startup, possible causes:
1. `forChunk` doesn't call `chunk.getPos()` directly — check decompiled source for the actual method call
2. The method is on a different type (e.g., `LevelHeightAccessor.getPos()`) — update the target descriptor
3. `forChunk` has been renamed in 1.21.11 — check the actual method name in decompiled NoiseChunk

**Fallback approach** if @Redirect fails: Use `@ModifyArg` with a fully-qualified constructor target:
```java
target = "Lnet/minecraft/world/level/levelgen/NoiseChunk;<init>(ILnet/minecraft/world/level/levelgen/RandomState;II...)V"
```
(Fill in the exact descriptor from the decompiled constructor)

---

## Previous Sessions Summary

### Session 1 (before this conversation)
- Created initial TorusChunkGenerator with delegation to NoiseBasedChunkGenerator
- Tried wrapping in getBaseHeight/getBaseColumn, WrappedChunkAccess, fillFromNoise copy — all compiled but didn't wrap

### Session 2 (February 21, 2026)
- Diagnosed ThreadLocal invisible to async worker threads
- Fixed with `static volatile boolean TORUS_ACTIVE`
- Added 7 mixins for coordinate wrapping at all pipeline stages
- Fixed SurfaceRulesContextMixin injection point (HEAD→TAIL) and coordinate scale
- Fixed biome source recursion guards (separated from torus flag)
- **Introduced the `@ModifyArg` bug** that Session 3 fixes

---

## Architecture (Current)

```
base.worldsize/
├── WorldSize.java              — ModInitializer, constants, wrapping utilities, player teleport
├── TorusChunkGenerator.java    — Extends ChunkGenerator, delegates to NoiseBasedChunkGenerator
└── mixin/
    ├── NoiseChunkMixin.java                    — Core: @Redirect on getPos() in forChunk()
    ├── MultiNoiseBiomeSourceMixin.java         — Wraps biome lookups (overworld)
    ├── FixedBiomeSourceMixin.java              — Wraps biome lookups (fixed biome)
    ├── CheckerboardColumnBiomeSourceMixin.java — Wraps biome lookups (checkerboard)
    ├── TheEndBiomeSourceMixin.java             — Wraps biome lookups (end)
    ├── SurfaceRulesContextMixin.java           — Wraps surface rule coordinates
    └── FeaturePlaceContextMixin.java           — Wraps feature placement origins

Resources:
├── fabric.mod.json
├── worldsize.mixins.json
├── data/worldsize/worldgen/world_preset/torus.json
├── data/minecraft/tags/worldgen/world_preset/normal.json
└── assets/worldsize/lang/en_us.json              ← FIXED LOCATION
```

## Known Issues / Follow-Up
1. Structure generation may not wrap correctly
2. Entity wrapping only covers players (not mobs/projectiles)
3. All dimensions wrap (Overworld, Nether, End) — per-dimension control not implemented
4. World size hardcoded to 64 chunks (1024 blocks)
5. Client-side rendering at wrap boundaries not addressed
6. Seamless visual transition at boundaries not implemented

## Key Lesson from Session 3
**Always qualify Mixin targets fully.** A bare `<init>` or method name can match multiple bytecode instructions. Use the fully-qualified owner class (`Lpackage/Class;methodName`) to ensure the correct instruction is targeted. When possible, prefer `@Redirect` on specific method calls over `@ModifyArg` on constructor parameters — it's harder to accidentally target the wrong thing.